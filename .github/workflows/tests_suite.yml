name: Linux Test Suite

on: [push]

jobs:
  test:
    name: Run pytest
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      # Display must be available globally for linux to know where xvfb is
      DISPLAY: ":99.0"
      QT_SELECT: "qt6"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: 3.12

    - name: Setup xvfb (Linux)
      run: |
        # require dependencies to create (GUI) app.
        sudo apt-get install -y xvfb libgl1-mesa-dev '^libxcb.*-dev' libglu1-mesa-dev libxrender-dev libxi-dev libxkbcommon-x11-dev

        # start xvfb in the background
        sudo /usr/bin/Xvfb $DISPLAY -screen 0 1280x1024x24 &

    - name: Install Poetry
      run: curl -sSL https://install.python-poetry.org | python3
      
    - name: Install dependencies
      run: poetry install

    - name: Open Web Client Directory
      working-directory: creator_administrator/laser/
      run: |
        ls -la

    - name: Open Web Client Directory
      working-directory: creator_administrator/laser/email_templates
      run: |
        ls -la

    - name: Run Pytest
      run: poetry run PYTHONPATH=$(pwd)/creator_administrator pytest

    - name: Run Pylint on src
      run: poetry run pylint --fail-under=8.0 --recursive=y --enable=W creator_administrator/src

    - name: Run Pylint on printer/src
      run: poetry run pylint --fail-under=8.0 --recursive=y --enable=W creator_administrator/printer/src

    - name: Run Pylint on laser/src
      run: poetry run pylint --fail-under=8.0 --recursive=y --enable=W creator_administrator/laser/src
